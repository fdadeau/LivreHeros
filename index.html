<!doctype html>

<html>

<head>
    <title>Livre dont vous êtes le héros</title>
    <script>
    
        
document.addEventListener("DOMContentLoaded", function(_e) {
    
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.status == 200 && this.readyState == 4) {
            parseAndDisplay(this.responseText);   
        }
    }
    xhttp.open("GET", "./textes/essai.txt");
    // xhttp.send();
    
    
    document.getElementById('fileinput').addEventListener('change', function(evt) {
        //Retrieve the first (and only!) File from the FileList object
        var f = evt.target.files[0]; 

        if (f) {
            var r = new FileReader();
            r.onload = function(e) { 
                var contents = e.target.result;  
                parseAndDisplay(contents);
            }
            r.readAsText(f);
        } else { 
            alert("Chargement du fichier impossible");
        }
        
        document.getElementById("frmLoading").reset();
    });
         
    /** Parse **/
    function parseAndDisplay(content) {

        document.body.innerHTML = "";  
            
        var nb = 0;
        
        var tab = content.split("[1]"); 
        
        do  {
            
            var section = document.createElement("section");
            section.id = nb;
            
            if (nb > 0) {
                section.innerHTML = parseChapitre(tab[0]);
            }
            else {
                section.innerHTML = "<p><a href='#1'>Démarrer</a></p>";   
            }
            document.body.appendChild(section);
            
            content = tab[1];
            nb++;
            tab = content.split("[" + (nb+1) + "]");
        }
        while (tab.length > 1)
    
        if (content.trim() != "") {
            var section = document.createElement("section");
            section.id = nb;
            section.innerHTML = parseChapitre(content);
            document.body.appendChild(section);
        }
        
        document.location.replace(document.location.href.substr(0, document.location.href.indexOf("#")) + "#0");
            
    }
    

    function parseChapitre(txt) {
        var t = txt.split("-->");
        
        // t[0] = titre + texte
        var t1 = t[0].split("\n\n");
        
        var html = "<h2>" + t1[0] + "</h2>";
        for (var i=1; i < t1.length; i++) {
            if (t1[i].trim() != "") {
                html += "<p>" + t1[i].replace("\n","<br>") + "</p>";
            }
        }
        for (var i=1; i < t.length; i++) {
            var t2 = t[i].split(":");
            html += (i > 1 ? "<br>" : "") + "<a href='#" + t2[0].trim() + "'>" + t2[1].trim() + "</a>"; 
        }
        return html;
    }
    
    
});      

    </script>
    
    <style type="text/css">
    
section {
    display: none;
    border: solid 1px #000;
    padding: 5px;
    margin: 10px 0;
}
        
section:target {
    display: block;
}
    
    </style>
    
</head>

<body>
    
    <form id="frmLoading">
        <p>Envoyer le fichier du scénario :</p>
        <input type="file" id="fileinput" />
    </form>
        
</body>


</html>